name: Process Markdown Images on Push

on:
  push:
    branches:
      - main
    paths:
      - 'platform/**/**/*.md' # åªåœ¨ Markdown æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘

jobs:
  process-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æˆäºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿æäº¤æ›´æ”¹

    steps:
      # 1ï¸âƒ£ æ‹‰å–ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼Œä»¥ä¾¿è¿›è¡Œ diff

      # 2ï¸âƒ£ è®¾ç½® Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pip install requests

      # 4ï¸âƒ£ è·å–æœ¬æ¬¡ push çš„ Markdown æ–‡ä»¶
      - name: Detect changed Markdown files
        id: detect_md
        shell: bash
        run: |
          echo "::group::Detect changed .md files"
          changed=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.md$' || true)
          echo "Changed md files:"
          echo "$changed"
          echo "::endgroup::"

          # å°†å¤šè¡Œè·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡ CHANGED_MD_FILES
          if [[ -n "$changed" ]]; then
            echo "CHANGED_MD_FILES<<EOF" >> "$GITHUB_ENV"
            echo "$changed" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
          fi

      # 5ï¸âƒ£ å¤„ç†æ¯ä¸ª Markdown æ–‡ä»¶
      - name: Process changed Markdown files
        shell: bash
        run: |
          if [[ -z "$CHANGED_MD_FILES" ]]; then
            echo "No changed Markdown files."
            exit 0
          fi

          echo "Processing changed Markdown files..."
          # é€è¡Œè¯»å–ç¯å¢ƒå˜é‡
          while IFS= read -r f; do
            # å¿½ç•¥ç©ºè¡Œ
            [[ -z "$f" ]] && continue
            if [ -f "$f" ]; then
              echo "ğŸ“„ Processing $f"
              python ./scripts/process_md_images.py "$f"
            else
              echo "âš ï¸ File not found: $f"
            fi
          done <<< "$CHANGED_MD_FILES"

      # 6ï¸âƒ£ æäº¤å¹¶æ¨é€æ›´æ–°
      - name: Commit and push changes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update local image paths for changed md files"
            git push origin main
          else
            echo "No changes to commit."
          fi
