name: Build and Deploy Docs

on:
  push:
    branches:
      - main
    paths:
      - 'platform/**/**/*.md' # åªåœ¨ Markdown æ–‡ä»¶å˜åŠ¨æ—¶è§¦å‘
  workflow_dispatch:

jobs:
  build-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æˆäºˆå†™å…¥æƒé™ï¼Œä»¥ä¾¿æäº¤æ›´æ”¹

    steps:
    # 1ï¸âƒ£ Checkout ä»“åº“
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ï¼Œä»¥ä¾¿è¿›è¡Œ diff

    # 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3ï¸âƒ£ å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install requests

    # 4ï¸âƒ£ è·å–æœ¬æ¬¡ push çš„å˜åŒ– Markdown æ–‡ä»¶
    - name: Detect changed Markdown files
      id: detect_md
      shell: bash
      run: |
        echo "::group::Detect changed .md files"
        changed=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.md$' || true)
        echo "Changed md files:"
        echo "$changed"
        echo "::endgroup::"

        # å°†å¤šè¡Œè·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡ CHANGED_MD_FILES
        if [[ -n "$changed" ]]; then
          echo "CHANGED_MD_FILES<<EOF" >> "$GITHUB_ENV"
          echo "$changed" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
        fi

# 5ï¸âƒ£ å¤„ç†å˜åŒ–çš„ Markdown æ–‡ä»¶ï¼ˆæŠ“å–å›¾ç‰‡ + è·¯å¾„ä¿®æ”¹ï¼‰
    - name: Process changed Markdown files
      shell: bash
      run: |
          if [[ -z "$CHANGED_MD_FILES" ]]; then
            echo "No changed Markdown files."
            exit 0
          fi

          echo "Processing changed Markdown files..."
          # é€è¡Œè¯»å–ç¯å¢ƒå˜é‡
          while IFS= read -r f; do
            # å¿½ç•¥ç©ºè¡Œ
            [[ -z "$f" ]] && continue
            if [ -f "$f" ]; then
              echo "ğŸ“„ Processing $f"
              python ./scripts/process_md_images.py "$f"
            else
              echo "âš ï¸ File not found: $f"
            fi
          done <<< "$CHANGED_MD_FILES"

    # 6ï¸âƒ£ æäº¤å¹¶æ¨é€æ›´æ–°
    - name: Commit and push changes
      shell: bash
      run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .

          if ! git diff --cached --quiet; then
            git commit -m "Auto-update local image paths for changed md files"
            git push origin main
          else
            echo "No changes to commit."
          fi

        

    # 7 æ„å»º homepageï¼ˆå¿…é€‰ï¼‰
    - name: Build homepage
      run: |
        mkdir -p docs_build
        sphinx-build -b html ./homepage ./docs_build

    # 8 æ„å»º platform å­é¡¹ç›®
    - name: Build platform docs
      run: |
        for project in platform/*/*; do
          if [ -f "$project/conf.py" ]; then
            echo "Building $project ..."
            project_name=$(basename $(dirname "$project"))
            platform_name=$(basename "$project")
            outdir="docs_build/$project_name/$platform_name"
            mkdir -p "$outdir"
            sphinx-build -b html "$project" "$outdir"
          fi
        done


    # æ¸…ç† /en/
    - name: Remove /en/ from sitemap URLs
      run: |
        for sm in docs_build/*/*/sitemap.xml; do
          if [ -f "$sm" ]; then
            echo "Cleaning $sm ..."
            sed -i 's#/en/#/#g' "$sm"
          fi
        done


    # 9 ç”Ÿæˆæ€» sitemap_index.xml
    - name: Generate sitemap_index.xml
      run: |
        echo '<?xml version="1.0" encoding="UTF-8"?>' > docs_build/sitemap_index.xml
        echo '<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> docs_build/sitemap_index.xml

        # éå†æ‰€æœ‰å­é¡¹ç›®çš„ sitemap.xml
        for sm in docs_build/*/*/sitemap.xml; do
          if [ -f "$sm" ]; then
            relpath=${sm#docs_build/}
            echo "  <sitemap>" >> docs_build/sitemap_index.xml
            echo "    <loc>https://docs.forlinx.net/$relpath</loc>" >> docs_build/sitemap_index.xml
            echo "  </sitemap>" >> docs_build/sitemap_index.xml
          fi
        done

        echo '</sitemapindex>' >> docs_build/sitemap_index.xml

    # 10 æ·»åŠ  CNAME æ–‡ä»¶ï¼ˆç»‘å®šè‡ªå®šä¹‰åŸŸåï¼‰
    - name: Add CNAME file
      run: echo "docs.forlinx.net" > ./docs_build/CNAME
      # å…³é”®æ­¥éª¤ï¼šå†™å…¥è‡ªå®šä¹‰åŸŸååˆ° docs_build/CNAME æ–‡ä»¶
      # è¿™æ · GitHub Pages æ‰˜ç®¡æ—¶ä¼šç»‘å®šè¿™ä¸ªåŸŸåï¼Œé˜²æ­¢è¢«éƒ¨ç½²è¦†ç›–åˆ é™¤

    # 11 éƒ¨ç½²åˆ° GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs_build
        publish_branch: gh-pages
